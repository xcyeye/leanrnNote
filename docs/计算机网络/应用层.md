# 应用层

应用层是计算机网络体系结构的最顶层，是设计和建立计算机网络的最终目的，也是计算机网络中发展的最快的部分

1. 早期基于文本的应用（电子邮件，远程登录，文件传输，新闻组）
2. 20世纪90年代将因特网带入千家万户的万维网WWW
3. 当今流行的即时通信，P2P文件共享及各种音视频应用
4. 计算设备的小型化和无处不在，宽带住宅接入和无线接入的日益普及和迅速发展，为未来更多的新型应用提供了广阔的舞台

![image-20220707083921416](https://picture.xcye.xyz/image-20220707083921416.png)

## 客户/服务器方式（C/S方式）和对等方式（P2P方式）

网络应用程序运行在处于网络边缘的不同的端系统上，通过彼此间的通信来共同完成某项任务，开发一种新的网络应用首先要考虑的问题就是网络应用程序在各种端系统上的组织方式和他们之间的关系，目前流行的方法主要有两种

1. 客户/服务器方式
2. 对等方式(Peer-to-Peer)



### CS方式

客户和服务器是指通信中所涉及的两个应用程序，客户/服务器方式所描述的是进程之间服务和被服务的关系

![image-20220707084850628](https://picture.xcye.xyz/image-20220707084850628.png)

正在运行的客户程序称为客户进程，简称为客户（运行客户进程的主机应称为客户计算机），处于网络边缘的主机B中运行的是服务器程序，正在运行的服务器程序称为服务器进程，简称为服务器（运行服务器进程的主机应称为服务器计算机），在客户/服务器方式下，客户向服务器请求服务，服务器收到服务请求后向客户提供服务

客户是服务的请求方，服务器是服务的提供方，服务器总是处于运行状态，并等待客户的服务请求，服务器具有固定的运输层端口号和IP地址，例如HTTP服务器的默认端口号为80

> 万维网WWW，电子邮件，文件传输FTP等都是使用C/S方式



基于C/S方式的应用服务通常是服务集中型的，即应用服务集中在网络中比客户计算机少得多的服务器计算机上，由于一台服务器计算机要为多个客户机提供服务，在C/S应用中，常会出现服务器计算机跟不上众多客户机请求的情况，因此，在C/S应用中，常用计算机集群（或服务器场）构建一个强大的虚拟服务器



### P2P

在P2P方式中，没有固定的服务请求者和服务提供者，分布在网络边缘各端系统中的应用进程是对等的，被称为对等方，对等方相互之间直接通信，每个对等方既是服务的请求者，又是服务的提供者

![image-20220707090804317](https://picture.xcye.xyz/image-20220707090804317.png)

处于主机边缘的CDEF中运行着同一种P2P程序，例如某种网络下载工具软件，E和F，C和D中的P2P进程各互为对等方，而E中的P2P进程还和D中的互为对等方，可以想象成E的P2P进程正在从F下载文件，与此同时还为D的P2P进程提供下载服务

因特网上流行的P2P应用主要包括P2P文件共享，即时通信，P2P流媒体，分布式存储等，基于P2P的应用是服务分散型的，因为服务不是集中在少数几个服务器计算机中，而是分散在大量对等计算机中，这些计算机并不为服务提供商所有，而是为个人控制的桌面计算机和笔记本电脑，他们通常位于住宅，校园和办公室中

> P2P方式的最突出特性之一就是它的可扩展性，因为系统每增加一个对等方，不仅增加的是服务的请求者，同时也增加了服务的提供者，系统性能不会因规模的增大而降低，还具有成本上的优势，它通常不需要庞大的服务器设施和服务器带宽，为了降低成本，服务提供商对于将P2P方式用于应用的兴趣也越来越大



## DHCP

作用：从DHCP服务器中自动获取主机的配置信息，包括IP地址，子网掩码等信息。

网络中各主机开机后自动启动DHCP程序，向DHCP服务器请求自己的网络配置信息，这样网络中的各主机就都可以从DHCP服务器自动获取网路配置信息，而不同人工手动进行配置

![image-20220707112456347](https://picture.xcye.xyz/image-20220707112456347.png)



### 工作过程

假设网络中存在一台用户主机和两台DHCP服务器，DHCP使用客户/服务器方式，在DHCP服务器上运行DHCP服务器进程，在用户主机上运行DHCP客户进程

> DHCP是TCP/IP协议体系应用层中的协议，使用运输层UDP所提供的服务（DHCP报文在运输层会被封装成UDP用户数据报）
>
> DHCP服务器使用的UDP端口是67，客户使用的UDP端口是68

封装有DHCP报文的UDP用户数据报，在网络层会被封装成IP数据报，然后再根据所使用的网络接口，封装成相应的数据链路层的帧进行发送（如封装成以太网帧）

![image-20220707113025077](https://picture.xcye.xyz/image-20220707113025077.png)

1. 当启用主机的DHCP后，DHCP客户将广播发送DHCP发现报文，封装该报文的IP数据报的源IP地址为`0.0.0.0`(因为客户主机还没有配置IP地址，使用该地址来代替)，目的地址为广播地址`255.255.255.255`

    > 发送广播的原因是用户主机现在并不知道网络中有哪几个DHCP服务器，他们的IP地址是什么

    ![image-20220707113319618](https://picture.xcye.xyz/image-20220707113319618.png)

    由于是广播的数据报，所以网络中所有设备都会收到该IP数据报，并对其进行层层解封，解封出封装有DHCP发现报文的UDP用户数据报，对于DHCP客户，其应用层层没有监听该UDP用户数据报目的端口67的进程（DHCP服务器进程），因此无法交付DHCP发现报文，只能丢弃。

    但是对于DHCP服务器，其应用层始终运行着DHCP服务器进程，因此会接收该DHCP发现报文并作出相应。

2. DHCP报文的格式比较复杂，对于DHCP发现报文，我们只需知道其内部封装有事物ID和DHCP客户端的MAC地址即可 

    ![image-20220707132131469](https://picture.xcye.xyz/image-20220707132131469.png)

    DHCP服务器收到DHCP发现报文后，根据其中封装的DHCP客户端的MAC地址来查找自己的数据库，看是否有针对该MAC地址的配置信息，如果有，则使用这些配置信息来构建并发送DHCP提供报文，如果没有，则采用默认配置信息来构建并发送DHCP提供报文，封装该报文的IP数据报的源地址为DHCP服务器的IP地址，目的IP地址仍为广播地址（原因：主机目前还没哟配置IP地址，为了使主机可以收到该报文，只能使用广播地址）。

    ![image-20220707132350877](https://picture.xcye.xyz/image-20220707132350877.png)

    网络中的所有设备都会收到该IP数据报，并对其进行层层解封，解封出封装有DHCP提供报文的UDP用户数据报，对于DHCP服务器，其应用层没有监听该UDP用户数据报目的端口68的进程（为何要说DHCP服务器：因为在一个网络中，DHCP服务器可能有多个，所以可能多个DHCP服务器都能收到该报文），因此无法交付DHCP提供报文，只能丢弃，但是对于DHCP客户，其应用层运行着DHCP客户进程，因此会接受该DHCP提供报文并作出相应的处理，DHCP客户会根据DHCP提供报文中的事物ID，来判断该报文是否是自己所请求的报文，也就是如果报文中的事物ID与自己之前发送的DHCP发现报文中封装的事物ID相等，那么就是自己之前开机发送的发现报文，就可以接受该报文，否则丢弃该报文

    ![image-20220707132838218](https://picture.xcye.xyz/image-20220707132838218.png)

    DHCP提供报文中还封装有配置信息，例如IP地址，子网掩码地址租期，默认网关，DNS服务器等，DHCP服务器从自己的IP地址池中挑选待租用给主机的IP地址时，会使用ARP来确保所选IP地址未被网络中其他主机占用

    ![image-20220707133038593](https://picture.xcye.xyz/image-20220707133038593.png)

3. DHCP客户会收到两个DHCP服务器发来的DHCP提供报文，DHCP从中选择一个，一般来说，选择先到的那个，并向所选择的DHCP服务器发送DHCP请求报文，封装该报文的IP数据报的源IP地址仍为`0.0.0.0`（因为现在客户才从多个DHCP服务器中选择一个作为自己的DHCP服务器，IP地址还没有配置），它首先需要征得该服务器的同意，之后才能正式使用向该DHCP服务器租用的IP地址

    ![image-20220707133420494](https://picture.xcye.xyz/image-20220707133420494.png)

    目的地址仍为广播地址（原因：不用向网络中每一个DHCP服务器单播发送DHCP请求报文，来告知他们是否请求他们作为自己的DHCP服务器），DHCP请求报文中封装有事物ID，DHCP客户端的MAC地址，接受的租约中的IP地址，提供此租约的DHCP服务器端的IP地址等信息

    ![image-20220707133640234](https://picture.xcye.xyz/image-20220707133640234.png)

4. 假设DHCP客户选择DHCP服务器1作为自己的DHCP服务器，并且DHCP服务器1接受该请求，于是DHCP服务器1给DHCP客户发送DHCP确认报文，封装该报文的IP数据报的源IP地址为DHCP服务器1的IP地址，目的IP地址仍为广播地址，DHCP客户收到该确认报文后，就可以使用所租用到的IP地址了

    ![image-20220707134024176](https://picture.xcye.xyz/image-20220707134024176.png)

    > 在使用租用到的IP地址之前，客户主机还会使用ARP检测该IP地址是否已被网络中其他主机占用，若被占用，DHCP客户会给DHCP服务器发送DHCP谢绝报文，来谢绝IP地址租约，并重新发送DHCP发现报文，若未被占用，则可以使用租约中的额IP地址与网络中的其他主机通信了

5. 当租用期过了一半时，DHCP客户会向DHCP服务器发送DHCP请求报文，来请求更新租用期，封装该报文的IP数据报的源IP地址为DHCP客户之前租用到的IP地址，目的IP地址为DHCP服务器1的地址

    ![image-20220707134423417](https://picture.xcye.xyz/image-20220707134423417.png)

    DHCP服务器1若同意，则发回DHCP确认报文，这样DHCP客户就得到了新的租用期，DHCP服务器若不同意，则发回DHCP否认报文，这时DHCP客户必须立即停止使用之前租用的IP地址，并重新发送DHCP发现报文来重新申请IP地址。

    DHCP服务器若未作出响应，则在租用期过了87.5%时，DHCP客户必须重新发送DHCP请求报文，然后继续等待DHCP服务器可能作出的反应

    ![image-20220707134810603](https://picture.xcye.xyz/image-20220707134810603.png)

    若DHCP服务器未作出响应，则当租用期后，DHCP客户必须立即停止使用之前租用的IP地址，并重新发送DHCP发现报文来重新申请IP地址，DHCP客户可以随时提前终止DHCP服务器所提供的租用期，这时只需要向DHCP服务器发送DHCP释放报文段即可

    ![image-20220707135518530](https://picture.xcye.xyz/image-20220707135518530.png)

![image-20220707135610630](https://picture.xcye.xyz/image-20220707135610630.png)

### DHCP中继代理

![image-20220707135641268](https://picture.xcye.xyz/image-20220707135641268.png)

上图网络中的主机广播发送DHCP发现报文，但该广播报文不会被路由器转发，而是丢弃

![image-20220707135733226](https://picture.xcye.xyz/image-20220707135733226.png)

解决方法是给该路由器配置DHCP服务器的IP地址，并使之成为DHCP中继代理，这样，该网络中的各主机就可以通过DHCP来自动获取到网络配置信息了

![image-20220707135847302](https://picture.xcye.xyz/image-20220707135847302.png)

该路由器收到DHCP报文后，会将其单播转发给DHCP服务器

![image-20220707140003468](https://picture.xcye.xyz/image-20220707140003468.png)



## 域名系统DNS

当我们在浏览器地址栏中输入某个Web服务器的域名时，用户主机会首先在自己的DNS高速缓存中查找该域名所对应的IP地址，如果没有找到，则会向网络中的某台DNS服务器查询，dns服务器中有域名和ip地址映射关系的数据库，当dns服务器收到dns查询报文后，在其数据库中进行查询，之后将查询结果发送给用户主机，然后用户主机中的浏览器就可以通过web服务器的ip地址对其进行访问了

![image-20220707142041407](https://picture.xcye.xyz/image-20220707142041407.png)

> 不能只使用一台dns服务器，因为因特网规模很大，这样的应服务器肯定会因为超负荷而无法正常工作，一旦域名服务器出现故障，整个因特网就会瘫痪。
>
> 早在1983年，因特网就开始采用层次结构的命名树作为主机的名字（域名），仅少量解析需要在因特网上通信，因此系统效率很高
>
> 由于dns是分布式系统，即使单个计算机出了故障，也不会妨碍整个系统的正常运行



### 因特网采用层次树状结构的域名结构

域名的结构由若干个分量组成，各分量之间用”.“隔开，分别代表不同级别的域名

![image-20220707142631426](https://picture.xcye.xyz/image-20220707142631426.png)

每一级的域名都由英文字母和数字组成，不超过63个字符，不区分大小写字母，级别最低的域名写在最左边，而级别最高的顶级域名写在最右边，完整的域名不超过255个字符

域名系统既不规定一个域名需要包含多少个下级域名，也不规定每一级的域名代表什么意思，各级域名由其上一级的域名管理机构管理，而最高的顶级域名则由因特网名称与数字地址分配机构ICANN进行管理



![image-20220707142931207](https://picture.xcye.xyz/image-20220707142931207.png)

#### 顶级域名

![image-20220707143037191](https://picture.xcye.xyz/image-20220707143037191.png)

![image-20220707143127841](https://picture.xcye.xyz/image-20220707143127841.png)

### DNS

域名和ip地址的映射关系必须保存在域名服务器中，供所有其他应用查询。显然不能将所有信息都储存在一台域名服务器中，DNS使用分布在各地的域名服务器来实现域名到IP地址的转换。

域名服务器可以划分为以下四种不同的类型

1. 根域名服务器

    根域名服务器是最高层次的域名服务器。每个根域名服务器都知道所有的顶级域名服务器的域名及其lP地址，因特网上共有13个不同1P地址的根城名服务器。

    尽省我们将这13个根域名服务器中的每一个都视为单个的服务器，但“每台服务器”实际上是由许多分布在世界各地的计算机构成的服务器集群。

    当本地域名服务器向根域名服务器发出查询请求时，路由器就把查询请求报文转发到离这个DNS客户最近的一个根域名服务器，这就加快了dns的查询过程，同时也更合理地利用了因特网的资源。

    根域名服务器通常并不直接对域名进行解祈，而返回该域名所属顶级域名的顶级域名服务器的IP地址。

2. 顶级域名服务器

    这些域名服务器负责管理在该顶级域名服务器注册的所有二级域名。当收到DNS查询请求时就给出相应的回答（可能是最后的结果，也可能是下一级权限域名服务器的1P地址）

3. 权限域名服务器

    这些域名服务器负责管理某个区的域名。每一个主机的域名都必须在某个权限域名服务器处注册登记。因此极限域名服务器知道其管理的域名与1P地址的映射关系。此外，校限域名服务器还知道其下级域名服务器的地址。

4. 本都域名服务器

    本地域名服务器不属于上述的域名服务器的等级结构。 当一个主机发出dns请求报文时，这个报文就首先被送往该主机的本地域名服务器。

    本地域名服务器起着代理的作用，会将该报文转发到上述的域名服务器的等级结构中。每一个因特网服务提供者ISP，一个大学，甚至一个大学里的学院，都可以拥有一个本地域名服务器，它有时也称为默认域名服务器。

    本地域名服务器离用户较近，一般不超过几个路由器的距离，也有可能就在同一个局域网中。本地域名服务器的1P地址需要直接配置在需要域名解析的主机中。



### 域名解析的过程

域名解析的过程有递归查询和迭代查询两种



#### 递归查询

假设主机想知道域名`y.abc.com`的IP地址，主机首先向其本地域名服务器进行递归查询，本地服务器收到递归查询的委托后，也采用递归查询的方式向某个根域名服务器查询

![image-20220707173903985](https://picture.xcye.xyz/image-20220707173903985.png)

根域名服务器收到递归查询的委托后，也采用递归查询的方式向某个顶级域名服务器查询，顶级域名服务器收到递归查询的委托后，也采用递归查询的方式向某个权限域名服务器查询

![image-20220707174031259](https://picture.xcye.xyz/image-20220707174031259.png)

当查询到域名所对应的IP地址后，查询结果会在之前受委托的各域名服务器之间传递，最终传回给用户主机

![image-20220707174125032](https://picture.xcye.xyz/image-20220707174125032.png)

#### 迭代查询

主机首先向其本地域名服务器进行递归查询，本地服务器采用迭代查询，它先向某个根域名服务器查询，根域名服务器告诉本地域名服务器，下一次应查询的顶级域名服务器的IP地址

![image-20220707174320162](https://picture.xcye.xyz/image-20220707174320162.png)

本地域名服务器向顶级域名服务器进行迭代查询，顶级域名服务器告诉本地域名服务器，下一次应查询的权限域名服务器的IP地址

![image-20220707174419296](https://picture.xcye.xyz/image-20220707174419296.png)

本地域名服务器向权限域名服务器进行迭代查询，权限域名服务器告诉本地域名服务器所查询的域名的IP地址，本地域名服务器最后把查询结果告诉主机

![image-20220707174533771](https://picture.xcye.xyz/image-20220707174533771.png)



> 由于递归查询对于被查询的域名服务器负担太大，通常采用以下模式：
>
> 从请求主机到本地域名服务器的查询是递归查询，而其余的查询是迭代查询。



> 为了提高DNS的查询效率，并减轻根域名服务器的负荷和减少因特网上的DNS查询报文数量，在域名服务器中广泛地使用了高速缓存。高速缓存用来存放最近查询过的域名以及从何处获得域名映射信息的记录（记录有时间限制）。



由于域名到IP地址的映射关系并不是永久不变，为保持高速缓存中的内容正确，域名服务器应为每项内客设
置计时器井删除超过合理时间的项（例如，每个项目只存放两天)。

不但在本地域名服务器中需要高速线存，在用户主机中也很需要。许多用户主机在启动时从本地域名服务器
下载域名和1P地址的全部数据库，维护存放自己最近使用的域名的高速缓存，井且只在从缓存中找不到域名时才向域名服务器查询。



![image-20220707175120244](https://picture.xcye.xyz/image-20220707175120244.png)

![image-20220707175203759](https://picture.xcye.xyz/image-20220707175203759.png)



## 文件传送协议FTP

将某台计算机中的文件通过网络传送到可能相距很远的另一台计算机中，是一项基本的网络应用，即文件传送。

FTP是因特网上使用最广泛的文件传送协议，提交互式的访问，尣许客户指明文件的类型与格式（如指明是否使用ASCII码〉，并允许文件具有存取权限（如访问文件的用户必须经过授权，井输入有效的口令），屏蔽了各计算机系统的细节，因而适合于在异构网络中任意计算机之间传送文件。



在因特网发展的早期阶段，用FTP传送文件约占整个因特网的通信量的三分之一，而由电子邮件和域名系统所产生的通信量还要小于FTP所产生的通信量。只是到了1995年，万维网WWW的通信量才首次超过了FTP。



FTP客户计算机可以将文件上传到FTP服务器，FTP客户计算机也可以从FTP服务器中下载文件

FTP服务器可以是一条高性能和高可用的服务器计算机，也可能只需要一台普通的个人计算机





### FTP服务器创建

我们可以在计算机或者服务器中使用第三方的FTP服务器软件，也可以使用操作系统自带的FTP服务器软件，例如使用Windows自带的FTP服务器功能创建一个FTP服务器站点，创建好了之后，会有一个FTP服务器的IP地址，在浏览器中访问即可

![image-20220707180250848](https://picture.xcye.xyz/image-20220707180250848.png)

操作文件可以使用软件，也可以使用命令

![image-20220707180511077](https://picture.xcye.xyz/image-20220707180511077.png)

### FTP工作原理

ftp服务器监听端口21，FTP客户随机选择一个临时端口号与其建立TCP连接，这条TCP连接用于FTP客户与服务器之间传送FTP的相关控制命令（命令通道）

![image-20220707180856130](https://picture.xcye.xyz/image-20220707180856130.png)

当有数据要传输时，FTP客户通过命令通道告知FTP服务器来与自己的另一个临时端口号建立TCP连接（建立数据通道）

![image-20220707181039156](https://picture.xcye.xyz/image-20220707181039156.png)

这时FTP客户随机选择另一个端口号，FTP服务器使用自己的熟知端口号20与其建立TCP连接（用于FTP客户与服务器之间传送文件）

![image-20220707181205172](https://picture.xcye.xyz/image-20220707181205172.png)

![image-20220707181249684](https://picture.xcye.xyz/image-20220707181249684.png)

> 控制连接在整个会话期间一直保持打开，用于传送FTP相关控制命令，数据连接用于文件传输，在每次文件传输时才建立，传输结束后就关闭，也就是和20端口建立连接的这条通道



![image-20220707181506634](https://picture.xcye.xyz/image-20220707181506634.png)



## 点子邮件

 电子邮件（E-mail) 是因特网上最早流行的一种应用，并且仍然是当今因特网上最重要、最实用的应用之一。

电子邮件系统采用客户/服务器方式

电子邮件系统的三个主要组成构件：用户代理，邮件服务器以及电子邮件所需的协议



在发送方和接收方的计算机中，需要使用用户代理来方法邮件

> 用户代理：用户与电子邮件系统的接口，又称为电子邮件客户端软件，比如qq邮件，网易邮件客户端等



邮件服务器是电子邮件系统的基础设施，因特网上所有的ISP都有邮件服务器，其功能是发送和接收邮件，同时还要负责维护用户的邮箱。





假设邮件服务器中含有很多待处理的邮件以及用来缓存待转发邮件的缓存，发送方使用用户代理通过邮件发送协议（SMTP）将邮件发送给发送方邮件服务器，发送方邮件服务器同样通过邮件发送协议将该邮件发送给接收方邮件服务器

![image-20220707223938370](https://picture.xcye.xyz/image-20220707223938370.png)

接收方在方便的时候，使用用户代理，通过邮件读取协议（POP3）从接收方邮件服务器读取邮件

![image-20220707224109745](https://picture.xcye.xyz/image-20220707224109745.png)

> 邮件协议包括邮件发送协议（如SMTP）和邮件读取协议（如POP3，IMAP等）



### 邮件发送和接收过程

发送方的用户代理作为SMTP客户，与发送方邮件服务器中的SMTP服务器进行TCP连接，然后基于这个连接，使用SMTP协议来发送邮件给发送方邮件服务器。

![image-20220707224349951](https://picture.xcye.xyz/image-20220707224349951.png)

发送方邮件服务器中的SMTP客户与接收方邮件服务器中的SMTP服务器进行TCP连接，然后基于这条连接使用SMTP协议来发送已收到的待转发邮件给接收方邮件服务器。

![image-20220707224537057](https://picture.xcye.xyz/image-20220707224537057.png)

接收方的用户代理作为POP3客户，与接收方邮件服务器中的POP3服务器进行TCP连接，然后基于这条连接使用POP3协议从接收方邮件服务器读取邮件。

![image-20220707224714679](https://picture.xcye.xyz/image-20220707224714679.png)

从上述可以看出，邮件发送协议的使用范围包含发送方用户代理到发送方邮件服务器，以及发送方邮件服务器到接收方邮件服务器这两部分。邮件的读取协议只有接收方用户代理到接收方邮件服务器这部分

![image-20220707224941855](https://picture.xcye.xyz/image-20220707224941855.png)



### SMTP的工作原理

全称`简单邮件传送协议`(Simple Mail Transfer Protocol)

以下为发送方邮件服务器使用SMTP给接收方邮件服务器发送待转发的邮件为例

1. 发送方邮件服务器周期性的扫描邮件缓存，如果发现有待转发的邮件，则发送方邮件服务器中的SMTP客户会与接收方邮件服务器中的SMTP服务器进行TCP连接，端口号为25，之后SMTP客户就可以基于这条TCP连接给SMTP服务器发送SMTP命令，总共有14条命令，SMTP服务器也会给SMTP客户发送相应的应答，共21种应答

    ![image-20220707225422726](https://picture.xcye.xyz/image-20220707225422726.png)

    SMTP客户与服务器之间通过命令与应答的交互方式最终实现SMTP客户发送邮件给SMTP服务器

2. 当TCP连接建立成功后，SMTP服务器会主动推送服务就绪应答给SMTP客户，应答代码220后面可能跟有描述信息

    ![image-20220707225652925](https://picture.xcye.xyz/image-20220707225652925.png)

3. SMTP客户收到该应答后，向服务器表明身份，告知自己SMTP服务器的域名。最终命令为`HELO`，其后为命令参数。

    ![image-20220707225827509](https://picture.xcye.xyz/image-20220707225827509.png)

4. SMTP服务器若认为身份有效，则发回应答代码250，否则发回其他代码（如421表示服务不可用）

   ![image-20220707230001383](https://picture.xcye.xyz/image-20220707230001383.png)
   
5. SMTP客户收到应答后，使用命令MAIL FROM来告诉服务器邮件来自何方

    ![image-20220707230133451](https://picture.xcye.xyz/image-20220707230133451.png)

6. SMTP服务器若认为合理，则发回应答代码250，否则发回其他错误代码，SMTP客户收到该应答后，使用命令`RCPT TO`来告诉服务器邮件去往何地（收件人邮箱），SMTP服务器中如果有该收件人邮箱，则发回应答代码250，否则发回其他错误代码，SMTP客户收到该应答后，使用`DATA`命令来告诉服务器自己准备发送邮件内容了。SMTP服务器如果准备好接收，返回应答代码354，否则发回其他错误代码。SMTP客户收到该应答后，就向服务器发送邮件内容，SMTP客户发送完邮件内容后，还要发送结束符，SMTP服务器若收件成功，则发回应答代码250，否则发回其他错误代码。SMTP客户收到该应答后，使用命令QUIT向服务器请求断开连接，SMTP服务器发回应答代码221表示接受请求并主动断开连接（上述过程省略了可能出现的认证过程）

    ![image-20220707231820624](https://picture.xcye.xyz/image-20220707231820624.png)



### 电子邮件的信息格式

> 电子邮件的信息格式井不是由SMTP定义的，而是在RFC 822中单独定义的。这个RFC文档己在2008年更新为RFC 5322。一个电子邮件有信封和内容两部分。而内容又由首部和主体两部分构成。

![image-20220707232056118](https://picture.xcye.xyz/image-20220707232056118.png)



SMTP协议只能传送ASCII码文本数据，不能传送可执行文件或其他的二进制对象。
SMTP不能满足传送多媒体邮件（例如带有图片、音频或视频数据）的需要，并且许多其他非英语国家的文字(例如中文、俄文、甚至带有重音符号的法文或德文）也无法用SMTP传送。
为解决SMTP传送非ASC1码文本的问题，提出了多用途因特网邮件扩展(MIME (Multpurpose Intemet Mail Extensions)

![image-20220707232257250](https://picture.xcye.xyz/image-20220707232257250.png)

![image-20220707232335490](https://picture.xcye.xyz/image-20220707232335490.png)



### 邮件读取

常用的邮件读取协议有：邮局协议POP，因特网邮件访问协议IMAP

- 邮局协议POP(Post Office Protocol)，POP3是其第三个版本，是因特网正式标准。
    非常简单，功能有限的邮件读取协议。用户只能以下载并删除方式或下载并保留方式从邮件服务器下载邮件到用户方计算机。不允许用户在邮件服务器上管理自己的邮件。〈例如创建文件夹：对邮件进行分类管理等）。
- 因特网邮件访问协议IMAP (lnteret Message Access Protacol)，IMAP4是其第四个版本，目前还只是因特网建议标准。
    功能比POP3强大的邮件读取协议。用户在自己前计算机上就可以操控邮件服务器中的邮箱，就像在本地操控一样，因此IMAP是一个联机协议。

![image-20220707232727051](https://picture.xcye.xyz/image-20220707232727051.png)

> POP3和IMAP4都采用基于TCP连接的客户/服务器方式。POP3使用熟知端口110，IMIAP4使用熟知端口143。





### 基于万维网的电子邮件

![image-20220707232913003](https://picture.xcye.xyz/image-20220707232913003.png)

![image-20220707232934137](https://picture.xcye.xyz/image-20220707232934137.png)

![image-20220707232950931](https://picture.xcye.xyz/image-20220707232950931.png)

